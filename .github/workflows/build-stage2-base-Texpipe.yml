name: build-texpipe
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      # 디스크 확보(필수)
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
          sudo apt-get clean
          docker system prune -af || true

      # nvdiffrast wheel을 어디선가 가져와서 wheels/에 둔다
      # 방법 A: repo에 올려둔 릴리즈 asset에서 다운로드
      # 방법 B: artifact 저장소에서 curl/wget로 다운로드
      - name: Fetch nvdiffrast wheel
        run: |
          mkdir -p wheels
          # 예시: 리포에 직접 넣지 말고, 너가 올린 wheel URL로 받기
          # curl -L "https://github.com/nokozan/my-containers/releases/download/v0.1/nvdiffrast-0.4.0-cp310-cp310-linux_x86_64.whl" -o wheels/nvdiffrast.whl
          # 파일명이 와일드카드 COPY에 맞게:
          ls -lh wheels

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (runtime only)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/stage2-texpipe.base.Dockerfile
          push: true
          tags: ghcr.io/nokozan/aue-stage2-base-texpipe:cuda118-py310
